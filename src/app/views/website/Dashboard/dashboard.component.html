<div class="dashboard-container">

  <ng-template #noDataTpl>
    <div style="text-align: center; color: rgba(0, 0, 0, 0.4); padding: 10px;">
      No Data Available
    </div>
  </ng-template>

  <div class="w-full">
    <div class="title-card">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h5 class="section-title">Welcome, {{ userName }}!</h5>
        <h5 class="section-title">{{ greeting }}</h5>
      </div>
    </div>
  </div>

  <div class="card-container" *ngIf="isAdmin || access.hasAnyAccess(featureRef)">
    <div class="balance-card shree">
      <div class="card-header-row">
        <h4>Shree Balance</h4>
        <div class="icon-bg">
          <i class="fa-solid fa-wallet"></i>
        </div>
      </div>
      <div>
        <h2 class="card-amount">{{ shreeBalance | currency : "INR" }}</h2>
        <p class="card-subtext">Total Cash Balance + Bank Balance</p>
      </div>
    </div>

    <div class="balance-card cash">
      <div class="card-header-row">
        <h4>Cash Balance</h4>
        <div class="icon-bg">
          <i class="fa-solid fa-money-bill-wave"></i>
        </div>
      </div>
      <div>
        <h2 class="card-amount">{{ cashBalance | currency : "INR" }}</h2>
        <p class="card-subtext">Cash Available</p>
      </div>
    </div>

    <div class="bank-card bank">
      <div class="card-header-row" style="width: 100%; align-items: center;">
        <div style="flex: 1;">
          <nz-select class="nzSelect-light" [nzNotFoundContent]="noDataTpl" nzShowSearch nzAllowClear
            id="BankAccountRef" name="BankAccountRef" [nzSize]="'large'" [(ngModel)]="BankAccountRef"
            (ngModelChange)="getBankCurrentBalance()" style="width: 100%;">
            <nz-option [nzValue]="0" [nzLabel]="'All Banks'"></nz-option>
            <nz-option *ngFor="let bank of BankList" [nzValue]="bank.p.BankAccountRef"
              [nzLabel]="bank.p.BankName"></nz-option>
          </nz-select>
        </div>
        <div class="icon-bg" style="margin-left: 10px;">
          <i class="fa-solid fa-building-columns"></i>
        </div>
      </div>
      <div style="margin-top: auto;">
        <h2 class="card-amount">{{ bankBalance | currency : "INR" }}</h2>
        <p class="card-subtext">Current Account Balance</p>
      </div>
    </div>
  </div>

  <div class="chart-container" *ngIf="isAdmin || access.hasAnyAccess(featureRef)">
    <div class="chart-card">
      <div class="chart-header">
        <div class="title-group">
          <p>Income VS Expense</p>
          <span>Inc: {{TotalIncome | currency:"INR" : 'symbol' : '1.0-0'}} vs Exp: {{TotalExpense | currency:"INR" :
            'symbol' : '1.0-0'}}</span>
        </div>

        <div class="filter-group">
          <nz-select class="nzSelect-light" style="width: 120px;" [(ngModel)]="BarSiteRef"
            (ngModelChange)="getDashboardStats()">
            <nz-option [nzValue]="0" [nzLabel]="'All Sites'"></nz-option>
            <nz-option *ngFor="let site of SiteList" [nzValue]="site.p.Ref" [nzLabel]="site.p.Name"></nz-option>
          </nz-select>

          <nz-select class="nzSelect-light" style="width: 100px;" [(ngModel)]="BarFilterType"
            (ngModelChange)="getDashboardStats()">
            <nz-option [nzValue]="57" [nzLabel]="'Weekly'"></nz-option>
            <nz-option [nzValue]="63" [nzLabel]="'Monthly'"></nz-option>
          </nz-select>

          <nz-select *ngIf="BarFilterType == 63" class="nzSelect-light" style="width: 120px;"
            [(ngModel)]="SelectedBarMonths" (ngModelChange)="getDashboardStats()">
            <nz-option *ngFor="let m of MonthList" [nzValue]="m.Ref" [nzLabel]="m.Name"></nz-option>
          </nz-select>
        </div>
      </div>
      <canvas id="barChart" class="doughnut"></canvas>
    </div>

    <div class="chart-card">
      <div class="chart-header">
        <div class="title-group">
          <p>Expense Breakdown</p>
        </div>
        <div class="filter-group">
          <nz-select class="nzSelect-light" style="width: 120px;" [(ngModel)]="DoughnutSiteRef"
            (ngModelChange)="getDashboardStats()">
            <nz-option [nzValue]="0" [nzLabel]="'All Sites'"></nz-option>
            <nz-option *ngFor="let site of SiteList" [nzValue]="site.p.Ref" [nzLabel]="site.p.Name"></nz-option>
          </nz-select>

          <nz-select class="nzSelect-light" style="width: 100px;" [(ngModel)]="DoughnutFilterType"
            (ngModelChange)="getDashboardStats()">
            <nz-option [nzValue]="57" [nzLabel]="'Weekly'"></nz-option>
            <nz-option [nzValue]="63" [nzLabel]="'Monthly'"></nz-option>
          </nz-select>

          <nz-select class="nzSelect-light" style="width: 100px;" [(ngModel)]="SelectedDoughnutMonths"
            (ngModelChange)="getDashboardStats()" *ngIf="DoughnutFilterType === 63">
            <nz-option *ngFor="let month of MonthList" [nzValue]="month.Ref" [nzLabel]="month.Name"></nz-option>
          </nz-select>
        </div>
      </div>
      <div class="chart-canvas-wrapper">
        <canvas id="doughnutChart"></canvas>
      </div>
    </div>
  </div>

  <div class="w-full my-4" *ngIf="isAdmin || access.hasAnyAccess(featureRef)">
    <div class="modern-card">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <h5 class="section-title">CRM Funnel Overview</h5>

        <div class="d-flex gap-2">
          <nz-select class="nzSelect-light" style="width: 140px;" [(ngModel)]="CRMSiteRef"
            (ngModelChange)="getDashboardStats()">
            <nz-option [nzValue]="0" [nzLabel]="'All Sites'"></nz-option>
            <nz-option *ngFor="let site of SiteList" [nzValue]="site.p.Ref" [nzLabel]="site.p.Name"></nz-option>
          </nz-select>

          <nz-select class="nzSelect-light" style="width: 100px;" [(ngModel)]="CRMFilterType"
            (ngModelChange)="getDashboardStats()">
            <nz-option [nzValue]="57" [nzLabel]="'Weekly'"></nz-option>
            <nz-option [nzValue]="63" [nzLabel]="'Monthly'"></nz-option>
          </nz-select>

          <nz-select *ngIf="CRMFilterType == 63" class="nzSelect-light" style="width: 120px;"
            [(ngModel)]="SelectedCRMMonths" (ngModelChange)="getDashboardStats()">
            <nz-option *ngFor="let m of MonthList" [nzValue]="m.Ref" [nzLabel]="m.Name"></nz-option>
          </nz-select>
        </div>
      </div>

      <div class="funnel-grid">
        <div class="funnel-item">
          <p>Total Enquiries</p>
          <h4>{{TotalEnquiries}}</h4>
        </div>
        <div class="funnel-item">
          <p>Total Plots</p>
          <h4>{{TotalNoOfPlots}}</h4>
        </div>
        <div class="funnel-item">
          <p>Sold Plots</p>
          <h4>{{TotalNoOfSoldPlots}}</h4>
        </div>
        <div class="funnel-item">
          <p>Revenue</p>
          <h4 style="color: var(--success-green);">{{TotalRevenueGenerated | currency : "INR" : 'symbol' : '1.0-0' }}
          </h4>
        </div>
      </div>
    </div>

    <div class="modern-card">
      <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h5 class="section-title">Bills Payable</h5>
        <div class="d-flex gap-2">
          <nz-select class="nzSelect-light" style="width: 150px;" [(ngModel)]="BillsPayableSiteRef"
            (ngModelChange)="getInvoiceSumExpenseSumListByCompanySiteMonthFilterType()">
            <nz-option [nzValue]="0" [nzLabel]="'All Sites'"></nz-option>
            <nz-option *ngFor="let Site of SiteList" [nzValue]="Site.p.Ref" [nzLabel]="Site.p.Name"></nz-option>
          </nz-select>

          <nz-select class="nzSelect-light" style="width: 100px;" [(ngModel)]="BillPayableFilterType"
            (ngModelChange)="getInvoiceSumExpenseSumListByCompanySiteMonthFilterType()">
            <nz-option [nzValue]="57" [nzLabel]="'Weekly'"></nz-option>
            <nz-option [nzValue]="63" [nzLabel]="'Monthly'"></nz-option>
          </nz-select>

          <nz-select *ngIf="BillPayableFilterType == 63" class="nzSelect-light" style="width: 120px;"
            [(ngModel)]="SelectedBillPayableMonths"
            (ngModelChange)="getInvoiceSumExpenseSumListByCompanySiteMonthFilterType()">
            <nz-option *ngFor="let m of MonthList" [nzValue]="m.Ref" [nzLabel]="m.Name"></nz-option>
          </nz-select>
        </div>
      </div>

      <div class="table-responsive">
        <table class="custom-table">
          <thead>
            <tr>
              <th>Sr. No.</th>
              <th>Vendor</th>
              <th>Site</th>
              <th>Bill Amount</th>
              <th>Given Amount</th>
            </tr>
          </thead>
          <tbody *ngIf="InvoiceSumExpenseSumList.length > 0">
            <tr *ngFor="let rec of InvoiceSumExpenseSumList | slice : 0 : 10; index as i">
              <td>{{ i + 1 }}</td>
              <td style="font-weight: 600;">{{ rec.p.RecipientName }}</td>
              <td>
                <span style="background: #f1f5f9; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">
                  {{ rec.p.SiteName }}
                </span>
              </td>
              <td style="color: var(--danger-red);">{{ rec.p.InvoiceAmount | currency : 'INR' }}</td>
              <td style="color: var(--success-green);">{{ rec.p.GivenAmount | currency : 'INR' }}</td>
            </tr>
            <tr *ngIf="InvoiceSumExpenseSumList.length > 10">
              <td colspan="5" class="text-center">
                <a style="cursor:pointer; color: var(--primary-earth); font-weight:600;"
                  (click)="goToBillsPayablePage()">
                  View All Transactions â†’
                </a>
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="InvoiceSumExpenseSumList.length === 0" class="d-flex align-items-center justify-content-center"
          style="height: 150px; background: #fafafa; border-radius: 8px;">
          <span style="color: #999;">No pending bills found.</span>
        </div>
      </div>
    </div>
  </div>

  <div class="w-full my-4" *ngIf="!isAdmin">
    <div class="modern-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="section-title">Today's Attendance</h5>
      </div>

      <div class="table-responsive">
        <table class="custom-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Employee</th>
              <th>Location</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let person of todayAttendanceList; index as i">
              <td>{{ i + 1 }}</td>
              <td style="font-weight: 600;">{{ person.p.EmployeeName || '-' }}</td>
              <td>{{ person.p.AttendanceLogDetailsArray[0]?.AttendenceLocationType === LocationType.Office ? 'Office' : (person.p.AttendanceLogDetailsArray[0]?.SiteName || '--') }}</td>
              <td>
                <ion-badge [color]="getStatusColor(person)" style="padding: 6px 10px; font-weight: 500;">
                  {{ getStatusText(person) }}
                </ion-badge>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>