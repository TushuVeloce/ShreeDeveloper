<app-header title="Attendance"></app-header>
<ion-content class="ion-padding">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- <ng-container *ngIf="isAdmin">
    <div class="admin-container">
      <h2 class="admin-title">Admin Dashboard</h2>
      <ion-searchbar 
        (ionInput)="onEmployeeSearch($event)" 
        placeholder="Search for an employee" 
        [debounce]="500" 
      ></ion-searchbar>
      
      <ion-list *ngIf="employeeSearchTerm$.value && filteredEmployeeList.length > 0" class="employee-search-results">
        <ion-item *ngFor="let employee of filteredEmployeeList" (click)="onEmployeeSelect(employee)">
          {{ employee.p.Name }}
        </ion-item>
      </ion-list>
      <ion-card *ngIf="selectedEmployeeRef" class="employee-card">
        <ion-card-header>
          <ion-card-title>Selected Employee</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>{{ 'employeeList.find(e => e.p.Ref === selectedEmployeeRef)?.p.Name '}}</p>
        </ion-card-content>
      </ion-card>
    </div>
  </ng-container> -->

  <ng-container *ngIf="!isAdmin">
    <div class="top-card">
      <div class="today-info">
        <p class="date-label">
          Today, {{ currentDateTime ? formatDate(currentDateTime) : "--" }}
        </p>
        <div class="time-group">
          <div class="time-item">
            <p class="label">Check In</p>
            <h1 class="time-value">
              {{ checkInTime ? convertTo12HourFormat(checkInTime) : "--" }}
            </h1>
          </div>
          <div class="time-item">
            <p class="label">Check Out</p>
            <h1 class="time-value">
              {{ checkOutTime ? convertTo12HourFormat(checkOutTime) : "--" }}
            </h1>
          </div>
        </div>
      </div>

      <div class="punch-btn-container">
        <ion-button
          expand="block"
          size="large"
          shape="round"
          [color]="attendanceStatus === 'checkedIn' ? 'secondary' : 'primary'"
          [disabled]="
            attendanceStatus === 'onLeave' || attendanceStatus === 'disabled'
          "
          (click)="
            attendanceStatus === 'checkedIn'
              ? submitPunchOut()
              : openPunchModal()
          "
        >
          <ion-ripple-effect></ion-ripple-effect>
          <ion-icon
            *ngIf="isSubmitting"
            name="sync-circle-outline"
            class="spinner-icon"
          ></ion-icon>
          {{
            isSubmitting
              ? "Processing..."
              : attendanceStatus === "checkedIn"
              ? "PUNCH OUT"
              : "PUNCH IN"
          }}
        </ion-button>
        <ion-text *ngIf="attendanceStatus === 'onLeave'" class="leave-message"
          >You are on leave today</ion-text
        >
      </div>
    </div>
  </ng-container>

  <div class="grid-mobile-app">
    <ion-grid>
      <ion-row class="grid-row-mobile-app">
        <ion-col
          *ngFor="let item of gridItems"
          size="6"
          [size]="gridItems.length % 2 == 0 ? '6' : '4'"
          class="grid-item-wrapper-mobile-app"
        >
          <div class="grid-item-mobile-app" [routerLink]="item.routerPath">
            <img [src]="item.icon" [alt]="item.label" />
          </div>
          <p class="grid-label-mobile-app">{{ item.label }}</p>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <ion-card class="attendance-table-card" *ngIf="!isAdmin">
    <ion-card-header>
      <ion-grid>
        <ion-row class="header-row ion-align-items-center">
          <ion-col size="6" class="ion-text-start">
            <ion-card-title class="header-title"
              >Recent Attendance</ion-card-title
            >
          </ion-col>
          <ion-col size="6" class="ion-text-end">
            <ion-select
              class="week-select"
              mode="ios"
              interface="popover"
              [(ngModel)]="selectedAttendanceLogType"
              (ionChange)="onAttendanceLogTypeChange()"
            >
              <ion-select-option
                *ngFor="let AttendanceLogType of AttendanceLogTypeList"
                [value]="AttendanceLogType.Ref"
              >
                {{ AttendanceLogType.Name }}
              </ion-select-option>
            </ion-select>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-card-header>

    <ion-card-content>
      <ion-grid class="attendance-table-header">
        <ion-row>
          <ion-col size="4"><strong>Date</strong></ion-col>
          <ion-col size="2" class="text-center"><strong>In</strong></ion-col>
          <ion-col size="2" class="text-center"><strong>Out</strong></ion-col>
          <ion-col size="4" class="text-center"><strong>Hours</strong></ion-col>
        </ion-row>
      </ion-grid>

      <ng-container *ngIf="filteredWeeklyAttendanceLogs.length > 0">
        <ion-grid class="attendance-table-body">
          <ion-row
            *ngFor="let day of filteredWeeklyAttendanceLogs"
            class="attendance-row"
          >
            <ion-col size="4">
              <div class="date-cell">
                {{ formatDate(day.p.TransDateTime) || "--" }}
              </div>
            </ion-col>
            <ion-col size="2" class="text-center">{{
              day.p.FirstCheckInTime
                ? convertTo12HourFormat(day.p.FirstCheckInTime)
                : "--"
            }}</ion-col>
            <ion-col size="2" class="text-center">{{
              day.p.LastCheckOutTime
                ? convertTo12HourFormat(day.p.LastCheckOutTime)
                : "--"
            }}</ion-col>
            <ion-col size="4" class="text-center">{{
              day.p.DisplayTotalWorkingHrs || "--"
            }}</ion-col>
          </ion-row>
        </ion-grid>
      </ng-container>

      <div
        class="no-data-box"
        *ngIf="
          filteredWeeklyAttendanceLogs.length == 0 &&
          !loadingService.isLoaderActive()
        "
      >
        <ion-icon name="alert-circle-outline"></ion-icon>
        <p>No attendance data found</p>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Check IN Modal -->
  <ion-modal
    [isOpen]="punchModalOpen"
    (didDismiss)="punchModalOpen = false"
    class="custom-modal-mobile-app"
  >
    <ng-template>
      <ion-header class="modal-toolbar-mobile-app">
        <ion-toolbar color="primary">
          <ion-title>Check In</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="punchModalOpen = false">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <!-- Scrollable Body -->
      <ion-content scroll-y="true" class="modal-content-mobile-app">
        <ion-list lines="none" class="ion-padding">
          <ion-item
            class="input-item"
            button
            (click)="selectAttendanceLocationBottomsheet()"
            detail
          >
            <ion-label>Location Type</ion-label>
            <ion-text slot="end" class="status-text">{{
              AttendanceLocationTypeName
            }}</ion-text>
          </ion-item>
          <ion-item
            class="input-item"
            button
            (click)="selectSiteBottomsheet()"
            *ngIf="
              this.AttendanceLocationTypeRef === AttendanceLocationTypes.Site
            "
            detail
          >
            <ion-label>Select Site</ion-label>
            <ion-text slot="end" class="status-text">{{ SiteName }}</ion-text>
          </ion-item>
          <div class="photo-upload">
            <ion-label class="section-title">Capture Photos</ion-label>
            <div class="photo-row">
              <div class="photo-item">
                <ion-label>Self Photo</ion-label>
                <div class="photo-placeholder" (click)="takePhoto('before')">
                  <img
                    *ngIf="capturedSelfPhoto"
                    [src]="capturedSelfPhoto"
                    class="preview-img"
                    alt="Self Photo Preview"
                  />
                  <ion-icon
                    *ngIf="!capturedSelfPhoto"
                    name="camera-outline"
                    class="camera-icon"
                  ></ion-icon>
                </div>
              </div>
              <div class="photo-item">
                <ion-label>Work Location</ion-label>
                <div class="photo-placeholder" (click)="takePhoto('after')">
                  <img
                    *ngIf="capturedWorkLocationPhoto"
                    [src]="capturedWorkLocationPhoto"
                    class="preview-img"
                    alt="Work Location Photo Preview"
                  />
                  <ion-icon
                    *ngIf="!capturedWorkLocationPhoto"
                    name="camera-outline"
                    class="camera-icon"
                  ></ion-icon>
                </div>
              </div>
            </div>
          </div>
        </ion-list>
      </ion-content>

      <ion-footer class="modal-footer-mobile-app">
        <ion-button
          expand="block"
          color="primary"
          shape="round"
          [disabled]="isSubmitting"
          (click)="submitPunchIn()"
        >
          <ion-spinner *ngIf="isSubmitting" slot="start"></ion-spinner>
          Submit Punch
        </ion-button>
      </ion-footer>
    </ng-template>
  </ion-modal>
</ion-content>
