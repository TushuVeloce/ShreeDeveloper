<app-header-with-back-handler title="Site Management"
  backRoute="mobile-app/tabs/dashboard"></app-header-with-back-handler>

<ion-content [fullscreen]="true" class="ion-padding site-management-content">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <ion-list class="site-list">
    <ng-container *ngIf="DisplayMasterList.length > 0">
      <div *ngFor="let site of DisplayMasterList" class="site-item-container">
        <ion-item button lines="none" class="site-item" (click)="toggleDetails(site.p.Ref)" detailIcon="none">
          <ion-label>
            <h2 class="site-title">{{ site.p.Name }}</h2>
            <p class="site-dates">
              <ion-icon name="calendar-outline"></ion-icon>
              <span>{{ formatDate(site.p.EstimatedStartingDate) }} - {{ formatDate(site.p.EstimatedEndDate) }}</span>
            </p>
          </ion-label>
          <div class="site-actions">
            <ion-button fill="clear" color="medium" (click)="$event.stopPropagation(); OpenActualStage(site);">
              <ion-icon name="arrow-forward-outline" slot="icon-only"></ion-icon>
            </ion-button>
          </div>
          <ion-icon name="chevron-down-outline" class="expand-icon"
            [ngClass]="{'rotated': selectedSiteId === site.p.Ref}"></ion-icon>
        </ion-item>

        <div class="collapsible-details-wrapper"
          [@expandCollapse]="selectedSiteId === site.p.Ref ? 'expanded' : 'collapsed'">
          <div class="collapsible-details-inner">
            <div class="detail-row">
              <span class="label">Estimated Start Date:</span>
              <span class="value">{{ formatDate(site.p.EstimatedStartingDate) }}</span>
            </div>
            <div class="detail-row">
              <span class="label">Estimated End Date:</span>
              <span class="value">{{ formatDate(site.p.EstimatedEndDate) }}</span>
            </div>
            <div class="detail-row">
              <span class="label">In charge:</span>
              <span class="value">{{ site.p.SiteInchargeName || '-' }}</span>
            </div>
            <div class="details-action-buttons">
              <ion-button expand="block" fill="solid" shape="round" color="primary" (click)="openModal(site)">View
                Details</ion-button>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <div *ngIf="DisplayMasterList.length === 0 && !loadingService.isLoaderActive()" class="no-data-mobile-app">
      <ion-icon name="alert-circle-outline"></ion-icon>
      <p>No site records found.</p>
    </div>
  </ion-list>

  <ion-modal [isOpen]="modalOpen" (didDismiss)="closeModal()" class="custom-modal-mobile-app">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Site Details</ion-title>
          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="closeModal()">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content scroll-y="true" class="ion-padding modal-content">
        <div class="modal-section">
          <h3>General Information</h3>
          <div class="info-row" *ngFor="let item of formattedSiteDetails">
            <span class="label">{{ item.label }}</span>
            <ng-container *ngIf="item.isLink; else normalValue">
              <!-- [href]="item.value" target="_blank" rel="noopener noreferrer"  -->
              <a class="link-value"  (click)="openLink(item.value)">
                <ion-icon name="navigate-circle-outline"></ion-icon>
                View on Map
              </a>
            </ng-container>
            <ng-template #normalValue>
              <span class="value">{{ item.value || '-' }}</span>
            </ng-template>
          </div>
        </div>
      </ion-content>

      <ion-footer>
        <ion-toolbar>
          <ion-button expand="block" color="primary" shape="round" (click)="closeModal()">Close</ion-button>
        </ion-toolbar>
      </ion-footer>
    </ng-template>
  </ion-modal>
</ion-content>